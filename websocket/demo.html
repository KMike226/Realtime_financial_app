<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket - Streaming de Donn√©es Financi√®res</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #229954;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-warning {
            background-color: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .data-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }
        
        .data-card h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        
        .symbol-data {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .symbol-data:last-child {
            border-bottom: none;
        }
        
        .symbol-name {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .price {
            font-size: 1.1em;
            font-weight: bold;
        }
        
        .price.positive {
            color: #27ae60;
        }
        
        .price.negative {
            color: #e74c3c;
        }
        
        .volume {
            font-size: 0.9em;
            color: #7f8c8d;
        }
        
        .change {
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .change.positive {
            color: #27ae60;
        }
        
        .change.negative {
            color: #e74c3c;
        }
        
        .indicators {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .indicator {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .indicator-label {
            font-size: 0.8em;
            color: #7f8c8d;
            margin-bottom: 4px;
        }
        
        .indicator-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .system-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .system-item {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .system-label {
            font-size: 0.8em;
            color: #7f8c8d;
            margin-bottom: 4px;
        }
        
        .system-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }
        
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-entry.info {
            color: #17a2b8;
        }
        
        .log-entry.success {
            color: #28a745;
        }
        
        .log-entry.warning {
            color: #ffc107;
        }
        
        .log-entry.error {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåê WebSocket - Streaming de Donn√©es Financi√®res</h1>
        
        <div id="status" class="status disconnected">
            üîå D√©connect√©
        </div>
        
        <div class="controls">
            <button id="connect-btn" class="btn-primary">üîó Se connecter</button>
            <button id="disconnect-btn" class="btn-danger">üîå Se d√©connecter</button>
            <button id="ping-btn" class="btn-warning">üèì Ping</button>
            <button id="status-btn" class="btn-warning">üñ•Ô∏è Statut serveur</button>
        </div>
        
        <div class="controls">
            <button id="subscribe-financial-btn" class="btn-success">üí∞ Donn√©es financi√®res</button>
            <button id="subscribe-technical-btn" class="btn-success">üìà Indicateurs techniques</button>
            <button id="subscribe-system-btn" class="btn-success">üñ•Ô∏è Statut syst√®me</button>
        </div>
        
        <div class="controls">
            <button id="subscribe-aapl-btn" class="btn-success">üçé AAPL</button>
            <button id="subscribe-btc-btn" class="btn-success">‚Çø BTC</button>
            <button id="subscribe-eth-btn" class="btn-success">Œû ETH</button>
        </div>
        
        <div id="error-message"></div>
        
        <div class="data-grid">
            <div class="data-card">
                <h3>üí∞ Donn√©es Financi√®res</h3>
                <div id="financial-data">
                    <p>Aucune donn√©e re√ßue</p>
                </div>
            </div>
            
            <div class="data-card">
                <h3>üìà Indicateurs Techniques</h3>
                <div id="technical-indicators">
                    <p>Aucun indicateur re√ßu</p>
                </div>
            </div>
            
            <div class="data-card">
                <h3>üñ•Ô∏è Statut Syst√®me</h3>
                <div id="system-status">
                    <p>Aucun statut re√ßu</p>
                </div>
            </div>
            
            <div class="data-card">
                <h3>üéØ Donn√©es de Symboles</h3>
                <div id="symbol-data">
                    <p>Aucune donn√©e de symbole re√ßue</p>
                </div>
            </div>
        </div>
        
        <div class="log">
            <h3>üìù Journal des √©v√©nements</h3>
            <div id="log-entries"></div>
        </div>
    </div>

    <!-- Script Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.esm.min.js" type="module"></script>
    
    <!-- Script principal -->
    <script type="module">
        import { io } from 'https://cdn.socket.io/4.7.2/socket.io.esm.min.js';
        
        class WebSocketDemo {
            constructor() {
                this.socket = null;
                this.connected = false;
                this.data = {
                    financial: new Map(),
                    technical: new Map(),
                    systemStatus: null,
                    symbolData: new Map()
                };
                
                this.initializeElements();
                this.setupEventListeners();
            }
            
            initializeElements() {
                this.elements = {
                    status: document.getElementById('status'),
                    connectBtn: document.getElementById('connect-btn'),
                    disconnectBtn: document.getElementById('disconnect-btn'),
                    pingBtn: document.getElementById('ping-btn'),
                    statusBtn: document.getElementById('status-btn'),
                    subscribeFinancialBtn: document.getElementById('subscribe-financial-btn'),
                    subscribeTechnicalBtn: document.getElementById('subscribe-technical-btn'),
                    subscribeSystemBtn: document.getElementById('subscribe-system-btn'),
                    subscribeAaplBtn: document.getElementById('subscribe-aapl-btn'),
                    subscribeBtcBtn: document.getElementById('subscribe-btc-btn'),
                    subscribeEthBtn: document.getElementById('subscribe-eth-btn'),
                    financialData: document.getElementById('financial-data'),
                    technicalIndicators: document.getElementById('technical-indicators'),
                    systemStatus: document.getElementById('system-status'),
                    symbolData: document.getElementById('symbol-data'),
                    errorMessage: document.getElementById('error-message'),
                    logEntries: document.getElementById('log-entries')
                };
            }
            
            setupEventListeners() {
                this.elements.connectBtn.addEventListener('click', () => this.connect());
                this.elements.disconnectBtn.addEventListener('click', () => this.disconnect());
                this.elements.pingBtn.addEventListener('click', () => this.ping());
                this.elements.statusBtn.addEventListener('click', () => this.getStatus());
                this.elements.subscribeFinancialBtn.addEventListener('click', () => this.subscribeToFinancial());
                this.elements.subscribeTechnicalBtn.addEventListener('click', () => this.subscribeToTechnical());
                this.elements.subscribeSystemBtn.addEventListener('click', () => this.subscribeToSystem());
                this.elements.subscribeAaplBtn.addEventListener('click', () => this.subscribeToSymbol('AAPL'));
                this.elements.subscribeBtcBtn.addEventListener('click', () => this.subscribeToSymbol('BTC'));
                this.elements.subscribeEthBtn.addEventListener('click', () => this.subscribeToSymbol('ETH'));
            }
            
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${type}`;
                logEntry.textContent = `[${timestamp}] ${message}`;
                this.elements.logEntries.appendChild(logEntry);
                this.elements.logEntries.scrollTop = this.elements.logEntries.scrollHeight;
            }
            
            updateStatus(connected) {
                this.connected = connected;
                if (connected) {
                    this.elements.status.className = 'status connected';
                    this.elements.status.textContent = '‚úÖ Connect√©';
                } else {
                    this.elements.status.className = 'status disconnected';
                    this.elements.status.textContent = 'üîå D√©connect√©';
                }
            }
            
            showError(message) {
                this.elements.errorMessage.innerHTML = `<div class="error-message">‚ùå ${message}</div>`;
                setTimeout(() => {
                    this.elements.errorMessage.innerHTML = '';
                }, 5000);
            }
            
            connect() {
                if (this.connected) return;
                
                this.log('Tentative de connexion au serveur WebSocket...', 'info');
                
                this.socket = io('http://localhost:5001', {
                    transports: ['websocket', 'polling'],
                    timeout: 10000
                });
                
                this.socket.on('connect', () => {
                    this.updateStatus(true);
                    this.log('‚úÖ Connexion √©tablie', 'success');
                });
                
                this.socket.on('disconnect', () => {
                    this.updateStatus(false);
                    this.log('üîå Connexion ferm√©e', 'warning');
                });
                
                this.socket.on('connected', (data) => {
                    this.log(`Connexion confirm√©e - Client ID: ${data.client_id}`, 'success');
                });
                
                this.socket.on('financial_data_update', (data) => {
                    this.data.financial.set(data.symbol, data.data);
                    this.updateFinancialDisplay();
                    this.log(`üí∞ ${data.symbol}: $${data.data.price.toFixed(2)}`, 'info');
                });
                
                this.socket.on('technical_indicators_update', (data) => {
                    this.data.technical.set(data.symbol, data.indicators);
                    this.updateTechnicalDisplay();
                    this.log(`üìà ${data.symbol}: RSI ${data.indicators.rsi.toFixed(1)}`, 'info');
                });
                
                this.socket.on('system_status_update', (data) => {
                    this.data.systemStatus = data;
                    this.updateSystemDisplay();
                    this.log(`üñ•Ô∏è Syst√®me: ${data.active_connections} connexions`, 'info');
                });
                
                this.socket.on('symbol_data', (data) => {
                    this.data.symbolData.set(data.symbol, data);
                    this.updateSymbolDisplay();
                    this.log(`üéØ ${data.symbol}: Prix $${data.financial_data.price.toFixed(2)}`, 'info');
                });
                
                this.socket.on('room_joined', (data) => {
                    this.log(`üö™ Rejoint la room '${data.room}'`, 'success');
                });
                
                this.socket.on('symbol_subscribed', (data) => {
                    this.log(`üìä Abonn√© au symbole '${data.symbol}'`, 'success');
                });
                
                this.socket.on('server_status', (data) => {
                    this.log(`üñ•Ô∏è Statut serveur: ${data.active_connections} connexions`, 'info');
                });
                
                this.socket.on('pong', (data) => {
                    this.log(`üèì Pong re√ßu`, 'success');
                });
                
                this.socket.on('error', (data) => {
                    this.log(`‚ùå Erreur: ${data.message}`, 'error');
                    this.showError(data.message);
                });
                
                this.socket.on('connect_error', (error) => {
                    this.log(`‚ùå Erreur de connexion: ${error.message}`, 'error');
                    this.showError(`Erreur de connexion: ${error.message}`);
                });
            }
            
            disconnect() {
                if (this.socket) {
                    this.socket.disconnect();
                    this.socket = null;
                }
            }
            
            ping() {
                if (this.socket && this.connected) {
                    this.socket.emit('ping');
                    this.log('üèì Ping envoy√©', 'info');
                }
            }
            
            getStatus() {
                if (this.socket && this.connected) {
                    this.socket.emit('get_status');
                    this.log('üñ•Ô∏è Demande du statut serveur', 'info');
                }
            }
            
            subscribeToFinancial() {
                if (this.socket && this.connected) {
                    this.socket.emit('join_room', { room: 'financial_data' });
                    this.log('üí∞ Abonnement aux donn√©es financi√®res', 'info');
                }
            }
            
            subscribeToTechnical() {
                if (this.socket && this.connected) {
                    this.socket.emit('join_room', { room: 'technical_indicators' });
                    this.log('üìà Abonnement aux indicateurs techniques', 'info');
                }
            }
            
            subscribeToSystem() {
                if (this.socket && this.connected) {
                    this.socket.emit('join_room', { room: 'system_status' });
                    this.log('üñ•Ô∏è Abonnement au statut syst√®me', 'info');
                }
            }
            
            subscribeToSymbol(symbol) {
                if (this.socket && this.connected) {
                    this.socket.emit('subscribe_symbol', { symbol });
                    this.log(`üìä Abonnement au symbole ${symbol}`, 'info');
                }
            }
            
            updateFinancialDisplay() {
                if (this.data.financial.size === 0) {
                    this.elements.financialData.innerHTML = '<p>Aucune donn√©e re√ßue</p>';
                    return;
                }
                
                let html = '';
                for (const [symbol, data] of this.data.financial) {
                    const changeClass = data.change >= 0 ? 'positive' : 'negative';
                    html += `
                        <div class="symbol-data">
                            <div>
                                <div class="symbol-name">${symbol}</div>
                                <div class="volume">Volume: ${data.volume.toLocaleString()}</div>
                            </div>
                            <div>
                                <div class="price ${changeClass}">$${data.price.toFixed(2)}</div>
                                <div class="change ${changeClass}">${data.change >= 0 ? '+' : ''}${data.change.toFixed(2)}%</div>
                            </div>
                        </div>
                    `;
                }
                this.elements.financialData.innerHTML = html;
            }
            
            updateTechnicalDisplay() {
                if (this.data.technical.size === 0) {
                    this.elements.technicalIndicators.innerHTML = '<p>Aucun indicateur re√ßu</p>';
                    return;
                }
                
                let html = '';
                for (const [symbol, indicators] of this.data.technical) {
                    html += `
                        <div class="symbol-data">
                            <div class="symbol-name">${symbol}</div>
                            <div class="indicators">
                                <div class="indicator">
                                    <div class="indicator-label">RSI</div>
                                    <div class="indicator-value">${indicators.rsi.toFixed(1)}</div>
                                </div>
                                <div class="indicator">
                                    <div class="indicator-label">MACD</div>
                                    <div class="indicator-value">${indicators.macd.toFixed(2)}</div>
                                </div>
                                <div class="indicator">
                                    <div class="indicator-label">SMA20</div>
                                    <div class="indicator-value">${indicators.sma_20.toFixed(2)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                this.elements.technicalIndicators.innerHTML = html;
            }
            
            updateSystemDisplay() {
                if (!this.data.systemStatus) {
                    this.elements.systemStatus.innerHTML = '<p>Aucun statut re√ßu</p>';
                    return;
                }
                
                const status = this.data.systemStatus;
                this.elements.systemStatus.innerHTML = `
                    <div class="system-info">
                        <div class="system-item">
                            <div class="system-label">Connexions</div>
                            <div class="system-value">${status.active_connections}</div>
                        </div>
                        <div class="system-item">
                            <div class="system-label">Symboles</div>
                            <div class="system-value">${status.monitored_symbols}</div>
                        </div>
                        <div class="system-item">
                            <div class="system-label">Statut</div>
                            <div class="system-value">${status.status}</div>
                        </div>
                        <div class="system-item">
                            <div class="system-label">Streaming</div>
                            <div class="system-value">${status.streaming_active ? 'Actif' : 'Inactif'}</div>
                        </div>
                    </div>
                `;
            }
            
            updateSymbolDisplay() {
                if (this.data.symbolData.size === 0) {
                    this.elements.symbolData.innerHTML = '<p>Aucune donn√©e de symbole re√ßue</p>';
                    return;
                }
                
                let html = '';
                for (const [symbol, data] of this.data.symbolData) {
                    const changeClass = data.financial_data.change >= 0 ? 'positive' : 'negative';
                    html += `
                        <div class="symbol-data">
                            <div>
                                <div class="symbol-name">${symbol}</div>
                                <div class="volume">Volume: ${data.financial_data.volume.toLocaleString()}</div>
                            </div>
                            <div>
                                <div class="price ${changeClass}">$${data.financial_data.price.toFixed(2)}</div>
                                <div class="change ${changeClass}">${data.financial_data.change >= 0 ? '+' : ''}${data.financial_data.change.toFixed(2)}%</div>
                            </div>
                            <div class="indicators">
                                <div class="indicator">
                                    <div class="indicator-label">RSI</div>
                                    <div class="indicator-value">${data.technical_indicators.rsi.toFixed(1)}</div>
                                </div>
                                <div class="indicator">
                                    <div class="indicator-label">MACD</div>
                                    <div class="indicator-value">${data.technical_indicators.macd.toFixed(2)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                this.elements.symbolData.innerHTML = html;
            }
        }
        
        // Initialisation de la d√©monstration
        const demo = new WebSocketDemo();
        demo.log('üåê D√©monstration WebSocket initialis√©e', 'info');
    </script>
</body>
</html>
